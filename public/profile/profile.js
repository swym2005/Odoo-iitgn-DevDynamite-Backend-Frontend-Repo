(function(){
  const { api } = window.FlowIQ;
  let profile=null; let hoursChart=null;
  function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }
  async function loadProfile(){ const res = await api.get('/profile'); profile = res.profile; hydrate(); await loadHours(); }
  function hydrate(){ if(!profile) return; setText('profName', profile.name); setText('profRole', profile.role); setText('profEmail', profile.email); setText('profTheme', profile.preferences?.theme||'system'); document.getElementById('fName').value=profile.name||''; document.getElementById('fPhone').value=profile.phone||''; document.getElementById('fLocation').value=profile.location||''; document.getElementById('prefTheme').value=profile.preferences?.theme||'system'; document.getElementById('prefEmail').value=String(profile.preferences?.notifications?.email!==false); document.getElementById('prefPush').value=String(profile.preferences?.notifications?.push!==false); }
  async function saveInfo(){ const fd=new FormData(); fd.append('name', document.getElementById('fName').value.trim()); fd.append('phone', document.getElementById('fPhone').value.trim()); fd.append('location', document.getElementById('fLocation').value.trim()); const av=document.getElementById('fAvatar').files[0]; if(av) fd.append('avatar', av); try{ const res= await fetch('/profile',{ method:'PUT', headers:{ 'Authorization': 'Bearer '+window.FlowIQ.auth.token() }, body: fd }); const data= await res.json(); if(!data.success) throw new Error(data.message||'Save failed'); profile=data.profile; hydrate(); alert('Saved'); }catch(e){ alert(e.message); } }
  async function changePassword(){ const cur=pwCurrent.value; const nw=pwNew.value; const cf=pwConfirm.value; if(!cur||!nw||nw.length<6||nw!==cf){ pwMsg.textContent='Check inputs (min 6 chars, match confirm).'; return; } pwMsg.textContent='Processingâ€¦'; try{ const res= await api.post('/profile/change-password',{ currentPassword:cur, newPassword:nw }); if(!res.success) throw new Error(res.message||'Failed'); pwMsg.textContent='Password updated'; pwCurrent.value=''; pwNew.value=''; pwConfirm.value=''; }catch(e){ pwMsg.textContent=e.message; } }
  async function savePrefs(){ const theme=prefTheme.value; const email=prefEmail.value==='true'; const push=prefPush.value==='true'; try{ const res= await api.put('/profile/preferences',{ theme, notifications:{ email, push } }); if(!res.success) throw new Error(res.message||'Failed'); profile=res.profile; hydrate(); alert('Preferences saved'); }catch(e){ alert(e.message); } }
  async function loadHours(){ try{ const res = await api.get('/timesheets/overview'); // Need an endpoint; placeholder fallback
      if(res?.hoursPerProject){ renderHours(res.hoursPerProject); } else { document.getElementById('usageLoading').textContent='No data'; } }catch{ document.getElementById('usageLoading').textContent='No data'; } }
  function renderHours(rows){ const el=document.getElementById('usageLoading'); if(el) el.remove(); if(!window.Chart) return; const labels=rows.map(r=>r.projectName||r.projectId?.slice(-6)); const data=rows.map(r=>r.hours||0); const ctx=document.getElementById('chartHours'); if(hoursChart){ hoursChart.data.labels=labels; hoursChart.data.datasets[0].data=data; hoursChart.update(); } else { hoursChart=new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ label:'Hours Logged', data, backgroundColor:'#8b5cf655', borderColor:'#8b5cf6' }] }, options:{ plugins:{legend:{labels:{color:'#e6edf5'}}}, scales:{x:{ticks:{color:'#9aa9bd'}}, y:{ticks:{color:'#9aa9bd'}}}} }); }
  }
  function bind(){ btnInfoSave.addEventListener('click', saveInfo); btnInfoReset.addEventListener('click', hydrate); btnPwChange.addEventListener('click', changePassword); btnPrefSave.addEventListener('click', savePrefs); btnPrefReset.addEventListener('click', hydrate); }
  document.addEventListener('DOMContentLoaded',()=>{ bind(); loadProfile(); });
})();